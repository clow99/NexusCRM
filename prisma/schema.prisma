datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  passwordHash    String
  name            String
  timezone        String   @default("UTC")
  currency        String   @default("USD")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  clients         Client[]
  deals           Deal[]
  tasks           Task[]
  notes           Note[]
  tags            Tag[]
}

model Client {
  id          String   @id @default(uuid())
  userId      String
  name        String
  company     String?
  email       String?
  phone       String?
  website     String?
  status      String   @default("lead") // lead, active, past
  nextContactAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals       Deal[]
  tasks       Task[]
  notes       Note[]
  tags        ClientTag[]

  @@index([userId])
}

model Deal {
  id                String   @id @default(uuid())
  userId            String
  clientId          String
  title             String
  value             Decimal  @default(0)
  currency          String   @default("USD")
  stage             String   @default("prospect") // prospect, proposal, negotiation, won, lost
  probability       Int      @default(0)
  expectedCloseDate DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  notes             Note[]
  tasks             Task[]   // Linked tasks
  activities        Activity[]

  @@index([userId])
  @@index([clientId])
}

model Task {
  id          String   @id @default(uuid())
  userId      String
  clientId    String?
  dealId      String?
  title       String
  dueDate     DateTime?
  priority    String   @default("medium") // low, medium, high
  status      String   @default("open")   // open, done
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  client      Client?  @relation(fields: [clientId], references: [id])
  deal        Deal?    @relation(fields: [dealId], references: [id])

  @@index([userId])
}

model Note {
  id          String   @id @default(uuid())
  userId      String
  clientId    String?
  dealId      String?
  content     String   @db.Text // Markdown
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  client      Client?  @relation(fields: [clientId], references: [id])
  deal        Deal?    @relation(fields: [dealId], references: [id])

  // Simple search index (for MVP)
  @@index([userId])
}

model Activity {
  id        String   @id @default(uuid())
  dealId    String
  type      String   // STAGE_CHANGE, etc.
  meta      Json?    // { from: "prospect", to: "proposal" }
  createdAt DateTime @default(now())

  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model Tag {
  id      String @id @default(uuid())
  userId  String
  name    String
  color   String // hex
  
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clients ClientTag[]
  
  @@unique([userId, name])
}

model ClientTag {
  clientId String
  tagId    String
  
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([clientId, tagId])
}
